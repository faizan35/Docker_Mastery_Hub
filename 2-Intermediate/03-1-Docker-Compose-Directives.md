# 3.3.1 Detailed Docker Compose Directives

## 2. Version Directive:

## 2. Services Directive:

- The `services` directive allows you to define the various containers (services) that compose your application.
- Each service represents a container and its configuration.

**Here's a breakdown of how to use the `services` directive:**

1.  **Syntax**: The `services` directive is defined at the root level of a Docker Compose YAML file.
2.  **Structure**: Under the `services` directive, you list each service by its name, followed by its configuration options.
3.  **Service Configuration Options**: Within each service definition, you can configure various options such as:

    - `image`: Specifies the Docker image to use for the service.
    - `build`: Specifies the path to the Dockerfile or a build context for building the image.
    - `ports`: Maps ports on the container to ports on the host machine.
    - `volumes`: Mounts host directories or named volumes to paths within the container.
    - `environment`: Sets environment variables for the container.
    - `depends_on`: Defines dependencies between services.
    - `networks`: Attaches the service to specified networks.

4.  **Example**:

```yaml
version: "3.8"

services:
  web:
    image: nginx:latest
    ports:
      - "80:80"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
    networks:
      - frontend
  app:
    build: ./app
    ports:
      - "5000:5000"
    depends_on:
      - db
    environment:
      - DEBUG=True
  db:
    image: postgres:latest
    environment:
      - POSTGRES_USER=user
      - POSTGRES_PASSWORD=password
    volumes:
      - db_data:/var/lib/postgresql/data
    networks:
      - backend
```

In this example:

- We define three services: `web`, `app`, and `db`.
- Each service has its own configuration, including the Docker image, ports, volumes, environment variables, and networks.
- The `depends_on` option ensures that the `app` service starts only after the `db` service is up and running.
- The `networks` option attaches each service to specific networks (`frontend` and `backend`).

## 3. Networks Directive:

- The `networks` directive in Docker Compose allows you to define custom networks for your containers.
- This enables you to control how containers communicate with each other and whether they are exposed to the external network.

**Here's how to use the `networks` directive:**

1.  **Syntax**: The `networks` directive is also defined at the root level of a Docker Compose YAML file.
2.  **Structure**: Under the `networks` directive, you define each network by its name, followed by its configuration options.
3.  **Network Configuration Options**: Within each network definition, you can configure options such as:

    - `driver`: Specifies the network driver to use (default is `bridge`).
    - `driver_opts`: Provides additional options specific to the chosen network driver.
    - `ipam`: Configures IP Address Management for the network, including subnet allocation.

4.  **Example**:

```yaml
networks:
  frontend:
    driver: bridge
  backend:
    driver: bridge
```

In this example:

- We define two networks: `frontend` and `backend`.
- Each network can have its own configuration, such as the network driver.
- By default, the `bridge` driver is used, which creates an isolated network for the containers.

### Usage:

Once you've defined your networks, you can attach your services to these networks by specifying them in the service configuration. For example:

```yaml
services:
  web:
    ...
    networks:
      - frontend
  app:
    ...
    networks:
      - backend
```

In this example:

- The `web` service is attached to the `frontend` network.
- The `app` service is attached to the `backend` network.

## 4. Volumes Directive:

- The `volumes` directive in Docker Compose allows you to define persistent storage volumes for your containers.
- Volumes are used to store data generated by containers or to share data between containers and the host machine.

**Here's how to use the `volumes` directive:**

1.  **Syntax**: Like the previous directives, the `volumes` directive is defined at the root level of a Docker Compose YAML file.
2.  **Structure**: Under the `volumes` directive, you define each volume by its name, followed by its configuration options.
3.  **Volume Configuration Options**: Within each volume definition, you can configure options such as:

    - `driver`: Specifies the volume driver to use (default is `local`).
    - `driver_opts`: Provides additional options specific to the chosen volume driver.
    - `external`: Indicates whether the volume is external (created outside of Docker Compose).

4.  **Example**:

```yaml
volumes:
  db_data:
```

In this example:

- We define a volume named `db_data`.
- By default, Docker Compose will create a local volume (host-mounted volume) with the same name as the one specified.

### Usage:

Once you've defined your volumes, you can mount them to specific paths within your containers by referencing their names in the `volumes` section of your service configuration. For example:

```yaml
services:
  db:
    ...
    volumes:
      - db_data:/var/lib/postgresql/data
```

In this example:

- The `db` service mounts the `db_data` volume to the path `/var/lib/postgresql/data` within the container.
- Any data written to this path inside the container will be stored persistently in the volume on the host machine.

## 5. Environment Variables:

- Environment variables are a fundamental aspect of configuring containerized applications.
- Docker Compose allows you to define and manage environment variables for your services, enabling you to customize their behavior dynamically.

**Here's how to use environment variables in Docker Compose:**

1.  **Syntax**: Environment variables can be specified under the `environment` key within each service definition in your Docker Compose YAML file.
2.  **Structure**: You can define environment variables as a list of key-value pairs or load them from external files using the `env_file` directive.
3.  **Example**:

```yaml
services:
  app:
    ...
    environment:
      - DEBUG=True
      - DB_HOST=db
      - DB_PORT=5432
```

In this example:

- We define three environment variables for the `app` service: `DEBUG`, `DB_HOST`, and `DB_PORT`.
- These variables can be accessed within the containerized application code.

1.  **External Environment Files**:

    Docker Compose allows you to load environment variables from external files using the `env_file` directive. This is useful for keeping sensitive information like passwords or API keys out of your Compose files.

```yaml
services:
  app:
    ...
    env_file:
      - ./app.env
```

In this example, Docker Compose will load environment variables from the `app.env` file located in the same directory as the Compose file.

## 6. Secrets Directive:

The `secrets` directive in Docker Compose allows you to manage sensitive data, such as passwords, API keys, and certificates, securely within your Docker Compose environment. It's especially useful for preventing sensitive information from being exposed in your Compose files or version control systems.

1.  **Syntax**: The `secrets` directive is also defined at the root level of a Docker Compose YAML file, similar to other directives.
2.  **Structure**: Under the `secrets` directive, you define each secret by its name, followed by its source.
3.  **Example**:

```yaml
secrets:
  db_password:
    file: ./db_password.txt
```

In this example:

- We define a secret named `db_password`.
- The secret is sourced from the `./db_password.txt` file located in the same directory as the Docker Compose file.

### Usage:

Once you've defined your secrets, you can use them within your service configurations as environment variables or mounted files. For example:

```yaml
services:
  db:
    ...
    environment:
      - POSTGRES_PASSWORD_FILE=/run/secrets/db_password
    secrets:
      - db_password
```

In this example:

- The `db` service uses the `db_password` secret as an environment variable named `POSTGRES_PASSWORD_FILE`.
- The secret is mounted as a file at `/run/secrets/db_password` within the container.

## Build Directive:

- The `build` directive in Docker Compose is used to specify the build context for a service.
- It allows you to build a Docker image directly from a Dockerfile or a directory containing the Dockerfile and associated files.

1.  **Syntax**: The `build` directive is defined within the service configuration in a Docker Compose YAML file.
2.  **Structure**: The `build` directive can take either a path to a directory containing the Dockerfile or a URL to a Git repository.
3.  **Example**:

```yaml
services:
  web:
    build: ./path/to/Dockerfile
```

In this example:

- We specify that the `web` service should be built from the Dockerfile located in the `./path/to/` directory.

---
